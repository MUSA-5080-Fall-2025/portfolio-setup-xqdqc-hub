---
title: "Assignment 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Qianmu Zheng"
date: today
format: 
  html:
    code-fold: false
    toc: true
    toc-location: left
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Assignment Overview

**Learning Objectives:**
- Apply spatial operations to answer policy-relevant research questions
- Integrate census demographic data with spatial analysis
- Create publication-quality visualizations and maps
- Work with spatial data from multiple sources
- Communicate findings effectively for policy audiences

---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**


#### Step 1: Data Collection (5 points)

```{r}
# Load required packages
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)
# Load spatial data
data_path <- "D:/Desktop/musa/5080_policy/5080/MUSA-5080-Fall-2025/lectures/week-04/data"
census_api_key("940dffa67b928a0518accaf8839aa7b4762b11ab")

pa_counties <- st_read(file.path(data_path, "Pennsylvania_County_Boundaries.shp"))
hospitals <- st_read(file.path(data_path, "hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE)

# Check that all data loaded correctly
hospitals <- st_transform(hospitals, st_crs(pa_counties))
census_tracts <- st_transform(census_tracts, st_crs(pa_counties))

head(pa_counties)
head(hospitals)
head(census_tracts)
```

```{r}
num_hospitals <- nrow(hospitals)
cat("Number of hospitals in dataset:", num_hospitals, "\n")

num_tracts <- nrow(census_tracts)
cat("Number of census tracts in dataset:", num_tracts, "\n")

cat("\n---- Coordinate Reference Systems ----\n")
cat("Counties CRS:\n"); print(st_crs(pa_counties))
cat("\nHospitals CRS:\n"); print(st_crs(hospitals))
cat("\nCensus Tracts CRS:\n"); print(st_crs(census_tracts))
```

---

#### Step 2: Get Demographic Data 

Use `tidycensus` to download tract-level demographic data for Pennsylvania.

```{r}
# Get demographic data from ACS
library(tidycensus)
library(dplyr)
library(sf)

acs_year <- 2022

pa_basic <- get_acs(
  geography = "tract",
  state = "PA",
  variables = c(
    total_pop = "B01003_001",
    median_income = "B19013_001"
  ),
  year = acs_year,
  survey = "acs5",
  geometry = FALSE,
  output = "wide"
)

pa_age <- get_acs(
  geography = "tract",
  state = "PA",
  variables = c(
    male_65_66 = "B01001_020",
    male_67_69 = "B01001_021",
    male_70_74 = "B01001_022",
    male_75_79 = "B01001_023",
    male_80_84 = "B01001_024",
    male_85plus = "B01001_025",
    female_65_66 = "B01001_044",
    female_67_69 = "B01001_045",
    female_70_74 = "B01001_046",
    female_75_79 = "B01001_047",
    female_80_84 = "B01001_048",
    female_85plus = "B01001_049"
  ),
  year = acs_year,
  survey = "acs5",
  geometry = FALSE
)

pa_age_summary <- pa_age %>%
  group_by(GEOID) %>%
  summarize(pop_65_over = sum(estimate, na.rm = TRUE))

pa_demo <- pa_basic %>%
  left_join(pa_age_summary, by = "GEOID") %>%
  select(GEOID, total_popE, median_incomeE, pop_65_over) %>%
  rename(
    total_pop = total_popE,
    median_income = median_incomeE
  )

# Join to tract boundaries
census_tracts_demo <- census_tracts %>%
  left_join(pa_demo, by = c("GEOID" = "GEOID"))


# What year of ACS data?
cat("ACS Year Used:", acs_year, "\n")

# How many tracts have missing income data?
missing_income <- sum(is.na(census_tracts_demo$median_income))
cat("Number of tracts with missing income data:", missing_income, "\n")

# What is the median income across all PA census tracts?
overall_median_income <- median(census_tracts_demo$median_income, na.rm = TRUE)
cat("Median income across all PA tracts:", dollar(overall_median_income), "\n")

```


---

#### Step 3: Define Vulnerable Populations 

Identify census tracts with vulnerable populations based on TWO criteria:
1. Low median household income (choose an appropriate threshold)
2. Significant elderly population (choose an appropriate threshold)

```{r}
#### Step 3: Define Vulnerable Populations ----

income_threshold <- 50000
elderly_threshold <- 0.15

census_tracts_demo <- census_tracts_demo %>%
  mutate(
    pct_elderly =  pop_65_over/ total_pop
  )

vulnerable_tracts <- census_tracts_demo %>%
  filter(
    median_income < income_threshold &
    pct_elderly > elderly_threshold
  )

num_vulnerable <- nrow(vulnerable_tracts)
total_tracts <- nrow(census_tracts_demo)
pct_vulnerable <- (num_vulnerable / total_tracts) * 100

cat("Income threshold:", income_threshold, "\n")
cat("Elderly population threshold:", elderly_threshold * 100, "%\n")
cat("Number of vulnerable tracts:", num_vulnerable, "\n")
cat("Percentage of PA tracts considered vulnerable:", round(pct_vulnerable, 2), "%\n")

```

---

#### Step 4: Calculate Distance to Hospitals 

For each vulnerable tract, calculate the distance to the nearest hospital.

```{r}
library(units)
# Transform to appropriate projected CRS
projected_crs <- 26918

vulnerable_tracts_proj <- st_transform(vulnerable_tracts, crs = projected_crs)
hospitals_proj <- st_transform(hospitals, crs = projected_crs)

tract_centroids <- st_centroid(vulnerable_tracts_proj)

dist_matrix <- st_distance(tract_centroids, hospitals_proj)
nearest_hospital_dist_m <- apply(dist_matrix, 1, min)

nearest_hospital_dist_miles <- as.numeric(nearest_hospital_dist_m) / 1609.34

vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(distance_to_hospital_miles = nearest_hospital_dist_miles)

avg_distance <- mean(vulnerable_tracts_proj$distance_to_hospital_miles, na.rm = TRUE)
max_distance <- max(vulnerable_tracts_proj$distance_to_hospital_miles, na.rm = TRUE)
num_over_15 <- sum(vulnerable_tracts_proj$distance_to_hospital_miles > 15, na.rm = TRUE)

cat("Average distance to nearest hospital (miles):", round(avg_distance, 2), "\n")
cat("Maximum distance to nearest hospital (miles):", round(max_distance, 2), "\n")
cat("Number of vulnerable tracts >15 miles from hospital:", num_over_15, "\n")

```

---

#### Step 5: Identify Underserved Areas 

Define "underserved" as vulnerable tracts that are more than 15 miles from the nearest hospital.

```{r}
# Create underserved variable

library(dplyr)

vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(
    underserved = distance_to_hospital_miles > 15
  )

num_underserved <- sum(vulnerable_tracts_proj$underserved, na.rm = TRUE)
total_vulnerable <- nrow(vulnerable_tracts_proj)
pct_underserved <- (num_underserved / total_vulnerable) * 100

cat("Number of underserved vulnerable tracts:", num_underserved, "\n")
cat("Percentage of vulnerable tracts that are underserved:", round(pct_underserved, 2), "%\n")

```

---

#### Step 6: Aggregate to County Level

Use spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.

```{r}
# Spatial join tracts to counties
#### Step 6: Aggregate to County Level ----

vulnerable_tracts_proj <- st_transform(vulnerable_tracts_proj, st_crs(pa_counties))

tracts_with_county <- st_join(vulnerable_tracts_proj, pa_counties, join = st_intersects, left = FALSE)

names(tracts_with_county)

county_summary <- tracts_with_county %>%
  st_drop_geometry() %>%
  group_by(NAMELSADCO) %>%
  summarize(
    num_vulnerable_tracts = n(),
    num_underserved_tracts = sum(underserved, na.rm = TRUE),
    pct_underserved = (num_underserved_tracts / num_vulnerable_tracts) * 100,
    avg_distance_miles = mean(distance_to_hospital_miles, na.rm = TRUE),
    total_vulnerable_pop = sum(total_pop, na.rm = TRUE)
  ) %>%
  arrange(desc(pct_underserved))

head(county_summary)

# Aggregate statistics by county

```


```{r}
top5_underserved <- county_summary %>%
  arrange(desc(pct_underserved)) %>%
  slice(1:5)
print(top5_underserved)

```
```{r}
top_vuln_far <- county_summary %>%
  arrange(desc(total_vulnerable_pop)) %>%
  slice(1:5)
print(top_vuln_far)

```
Most underserved counties tend to be located in rural northern and western Pennsylvania, where hospital density is lower and population centers are more dispersed. Urban counties (like Philadelphia or Allegheny) show fewer underserved tracts due to higher hospital accessibility.

---

#### Step 7: Create Summary Table 

Create a professional table showing the top 10 priority counties for healthcare investment.

```{r}
# Create and format priority counties table
#### Step 7: Create Summary Table ----

library(knitr)
library(scales)

priority_metric <- "pct_underserved"

priority_counties <- county_summary %>%
  arrange(desc(!!sym(priority_metric))) %>%
  slice(1:10) %>%
  mutate(
    num_vulnerable_tracts = comma(num_vulnerable_tracts),
    num_underserved_tracts = comma(num_underserved_tracts),
    pct_underserved = percent(pct_underserved / 100, accuracy = 0.1),
    avg_distance_miles = round(avg_distance_miles, 1),
    total_vulnerable_pop = comma(total_vulnerable_pop)
  ) %>%
  rename(
    `County` = NAMELSADCO,
    `Vulnerable Tracts` = num_vulnerable_tracts,
    `Underserved Tracts` = num_underserved_tracts,
    `% Underserved` = pct_underserved,
    `Avg Distance (mi)` = avg_distance_miles,
    `Total Vulnerable Population` = total_vulnerable_pop
  )

kable(
  priority_counties,
  caption = "Table 1. Top 10 Pennsylvania Counties Prioritized for Healthcare Investment",
  align = "lccccc",
  format = "markdown"
)

```

---

## Part 2: Comprehensive Visualization 

Using the skills from Week 3 (Data Visualization), create publication-quality maps and charts.

### Map 1: County-Level Choropleth 

Create a choropleth map showing healthcare access challenges at the county level.

```{r}
library(stringr)

county_summary <- county_summary %>%
  mutate(NAMELSADCO = str_replace(NAMELSADCO, " County$", ""))

```

```{r}
View(pa_counties)
View(county_summary)
```


```{r}
# Create county-level access map
#### Part 2: County-Level Choropleth ----

library(ggplot2)
library(sf)
library(scales)

pa_counties_proj <- st_transform(pa_counties, 26918)
hospitals_proj <- st_transform(hospitals, 26918)


county_summary_map <- pa_counties_proj %>%
  mutate(COUNTY_NAM = tolower(COUNTY_NAM)) %>%
  left_join(
    county_summary %>%
      mutate(NAMELSADCO = tolower(NAMELSADCO)),
    by = c("COUNTY_NAM" = "NAMELSADCO")
  )


ggplot() +
  geom_sf(
    data = county_summary_map,
    aes(fill = pct_underserved),
    color = "white",
    size = 0.2
  ) +

  scale_fill_gradient(
    low = "#DEEBF7",
    high = "#2171B5",
    name = "% Underserved Tracts",
    labels = function(x) paste0(round(x, 0), "%"),
    na.value = "grey90"
  ) +

  labs(
    title = "Healthcare Access Challenges Across Pennsylvania Counties",
    subtitle = "Percentage of vulnerable tracts that are more than 15 miles from the nearest hospital",
    caption = "Data sources: ACS 2022 (via tidycensus), Pennsylvania hospital data (Week 4 lecture)"
  ) +

  theme_void(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5),
    plot.caption = element_text(size = 9, hjust = 0.95, color = "gray40"),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )



```

---

### Map 2: Detailed Vulnerability Map 

Create a map highlighting underserved vulnerable tracts.

```{r}
# Create detailed tract-level map
#### Part 2: Map 2 - Detailed Vulnerability Map ----

pa_counties_proj <- st_transform(pa_counties, 26918)
hospitals_proj <- st_transform(hospitals, 26918)
vulnerable_tracts_proj <- st_transform(vulnerable_tracts_proj, 26918)

tract_map_data <- vulnerable_tracts_proj %>%
  mutate(
    tract_status = case_when(
      underserved ~ "Underserved Vulnerable Tract",
      TRUE ~ "Other Vulnerable Tract"
    )
  )

ggplot() +
  geom_sf(data = pa_counties_proj, fill = "gray95", color = "white", size = 0.3) +
  
  geom_sf(
    data = tract_map_data,
    aes(fill = tract_status),
    color = NA,
    alpha = 0.9
  ) +
  
  geom_sf(
    data = hospitals_proj,
    color = "red",
    size = 1.2,
    alpha = 0.8
  ) +
  
  scale_fill_manual(
    values = c(
      "Underserved Vulnerable Tract" = "#d73027",
      "Other Vulnerable Tract" = "#fee090"
    ),
    name = "Tract Type"
  ) +
  
  labs(
    title = "Underserved Vulnerable Tracts in Pennsylvania",
    subtitle = "Vulnerable tracts (low income & elderly) more than 15 miles from the nearest hospital are shown in red",
    caption = "Data: ACS 2022 (via tidycensus) and PA hospital data (Week 4 lecture)"
  ) +
  
  theme_void(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray20"),
    plot.caption = element_text(size = 9, color = "gray40", hjust = 0.95),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 9)
  )

```

---

### Chart: Distribution Analysis

Create a visualization showing the distribution of distances to hospitals for vulnerable populations.

```{r}
# Create distribution visualization
#### Chart: Distribution Analysis ----

library(ggplot2)
library(scales)

ggplot(vulnerable_tracts_proj, aes(x = distance_to_hospital_miles)) +
  geom_histogram(
    aes(y = after_stat(density)),
    bins = 30,
    fill = "#74c476",
    color = "white",
    alpha = 0.8
  ) +
  geom_density(color = "#006d2c", linewidth = 1) +
  geom_vline(xintercept = 15, linetype = "dashed", color = "red", linewidth = 1) +
  labs(
    title = "Distribution of Distances to Nearest Hospital for Vulnerable Tracts",
    subtitle = "Dashed red line indicates the 15-mile underserved threshold",
    x = "Distance to Nearest Hospital (miles)",
    y = "Density",
    caption = "Data: ACS 2022 (via tidycensus) and PA hospital data (Week 4 lecture)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray30"),
    plot.caption = element_text(size = 9, color = "gray40", hjust = 0.95),
    axis.title = element_text(face = "bold")
  )




```

---

## Part 3: Bring Your Own Data Analysis 

Choose your own additional spatial dataset and conduct a supplementary analysis.

1. **Find and load additional data**
   - Document your data source
   - Check and standardize the CRS
   - Provide basic summary statistics

```{r}
# Load your additional dataset
base_path = "D:\\Desktop\\musa\\5080_policy\\portfolio-setup-xqdqc-hub\\assignments\\assignment_2\\data"

schools <- st_read(file.path(base_path, "Schools\\Schools.shp"))
crime <- st_read(file.path(base_path,"incidents_part1_part2\\incidents_part1_part2.shp"))
bike_net <- st_read(file.path(base_path,"Bike_Network\\Bike_Network.shp"))
```
```{r}
cat("Schools CRS:\n"); print(st_crs(schools))
cat("\nCrime Incidents CRS:\n"); print(st_crs(crime))
cat("\nBike Network CRS:\n"); print(st_crs(bike_net))
```
```{r}
crime <- st_transform(crime, 3857)
```

```{r}
cat("\nSchools:\n")
cat("Number of schools:", nrow(schools), "\n")
print(st_geometry_type(schools) %>% table())
print(summary(st_bbox(schools)))

cat("\nCrime Incidents:\n")
cat("Number of records:", nrow(crime), "\n")
print(st_geometry_type(crime) %>% table())
print(summary(st_bbox(crime)))

cat("\nBike Network:\n")
cat("Number of segments:", nrow(bike_net), "\n")
print(st_geometry_type(bike_net) %>% table())
print(summary(st_bbox(bike_net)))
```

**Questions to answer:**
- What dataset did you choose and why?

I have chosen School dataset because I'm interested in young children issue.

- What is the data source and date?

Crime Incidents is in 2024, and I also have school dataset and bike network dataset.

- How many features does it contain?

Number of schools is 495, number of crime records is 160388, number of bike network segments is 5225.

- What CRS is it in? Did you need to transform it?

The CRS of schools and bike network data is EPSG 3857, the CRS of crime data is EPSG 4326. So I have got crime data transformed.

---

2. **Pose a research question**

Write a clear research statement that your analysis will answer.

This analysis investigates whether school zones in Philadelphia are safe environments, by examining the number of nearby crime incidents.

---

3. **Conduct spatial analysis**

```{r}
# Your spatial analysis
school_buffers <- st_buffer(schools, dist = 1000)

crime_join <- st_join(crime, school_buffers, join = st_within, left = FALSE)
```

```{r}
View(crime_join)
```


```{r}
school_crime_count <- crime_join %>%
  st_drop_geometry() %>%
  group_by(school_nam) %>%
  summarize(crime_count = n())

schools_with_crime <- schools %>%
  left_join(school_crime_count, by = "school_nam") %>%
  mutate(crime_count = replace_na(crime_count, 0))
```

```{r}
head(schools_with_crime)
```

```{r}
bike_in_buffers <- st_intersection(bike_net, school_buffers)

bike_coverage <- bike_in_buffers %>%
  st_drop_geometry() %>%
  group_by(school_nam) %>%
  summarize(bike_miles = sum(st_length(bike_in_buffers) / 5280))

schools_with_bike <- schools_with_crime %>%
  left_join(bike_coverage, by = c("school_nam")) %>%
  mutate(bike_miles = replace_na(bike_miles))

head(schools_with_bike)
```


```{r}
summary_tbl <- schools_with_bike %>%
  st_drop_geometry() %>%
  summarize(
    total_schools = n(),
    avg_crime = mean(crime_count, na.rm = TRUE),
    avg_bike = mean(bike_miles, na.rm = TRUE)
  )

print(summary_tbl)
```



```{r}
ggplot(data = schools_with_crime) +
  geom_sf(aes(color = crime_count), size = 2) +
  scale_color_viridis_c(
    option = "plasma",
    trans = "sqrt",
    name = "Crime Count"
  ) +
  labs(
    title = "Crime Incidents Within 1000ft of Philadelphia Schools",
    subtitle = "Each point represents a school, colored by number of nearby crime incidents",
    caption = "Data: OpenDataPhilly | Analysis: MUSA 5080 Assignment 3"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5, color = "gray30"),
    legend.position = "right"
  )

```


```{r}
ggplot(schools_with_crime, aes(x = crime_count)) +
  geom_histogram(
    bins = 30,
    fill = "pink",
    color = "white",
    alpha = 0.8
  ) +
  labs(
    title = "Distribution of Crime Incidents Within 1000ft of Schools",
    subtitle = "Each bar represents the number of schools by nearby crime count",
    x = "Number of Crime Incidents (within 1000ft)",
    y = "Number of Schools",
    caption = "Data: OpenDataPhilly | Analysis: MUSA 5080 Assignment 3"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5, color = "gray30"),
    plot.caption = element_text(size = 8, color = "gray50", hjust = 0.95)
  )

```

**My interpretation:**
The majority of Philadelphia schools experience a moderate number of nearby crime incidents, with most falling below 2,000 cases within a 1,000-ft radius. However, a few schools stand out as clear hotspots, with significantly higher counts exceeding 6,000 incidents, concentrated primarily in central and southern parts of the city. The histogram confirms this right-skewed distribution, where a small proportion of schools account for a disproportionately large share of nearby crimes. These findings suggest that while most school zones remain relatively safe, targeted safety interventions and “Safe Routes to School” programs should prioritize the high-crime areas identified in the analysis.
