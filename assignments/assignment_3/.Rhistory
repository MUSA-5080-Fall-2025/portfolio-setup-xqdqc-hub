low = "blue", mid = "white", high = "red",
midpoint = 0,
name = "Residuals"
) +
labs(
title = "Model 4 Residuals (Parcel Level)",
subtitle = "Red = Overestimated, Blue = Underestimated"
) +
theme_void()
parcel_data <- na.omit(parcel_data)
ctrl <- trainControl(
method = "cv",
number = 10  # 10-fold CV
)
model_cv1 <-  train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area +
garage_spaces +
Age + I(Age^2) +
exterior_good,
data = parcel_data,
method = "lm",
trControl = ctrl)
#load necessary libraries
library(sf)
library(tigris)
library(tidycensus)
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(caret)
library(knitr)
library(scales)
#load census key for later use
census_api_key("42bf8a20a3df1def380f330cf7edad0dd5842ce6")
#save data in url
url <- "https://phl.carto.com/api/v2/sql?filename=opa_properties_public&format=geojson&skipfields=cartodb_id&q=SELECT+*+FROM+opa_properties_public"
#suppress warnings for clarity and read data as spatial object
suppressWarnings({
property_data <- st_read(url)
})
#clean data
parcel_data <- property_data%>%
select(location, #load columns that could potentially be used as predictors
category_code_description, #maybe garage_spaces and central air too?
number_of_bedrooms,
number_of_bathrooms,
total_livable_area,
year_built,
exterior_condition,
garage_spaces,
sale_price,
sale_date)%>%
filter(category_code_description %in%
c("SINGLE FAMILY","MULTI FAMILY"))%>% #no apartments, sales price of building
drop_na(number_of_bedrooms, #remove anomalies like houses with no rooms
number_of_bathrooms,
total_livable_area,
sale_price,
year_built) %>%
filter(number_of_bedrooms>0,
number_of_bathrooms>0,
total_livable_area>0,
sale_price>=10000, sale_price <=1000000)%>% #remove very low/high prices
mutate(sale_year = str_remove(sale_date, "-.*"))%>%
filter(sale_year %in% c("2023","2024"))%>% #limit to only 2023 and 2024
mutate(year_built = as.numeric(year_built))%>%
mutate(Age = 2025 - year_built)%>% filter(Age <2000)%>% #create a age column
filter(exterior_condition != 0) %>% #create exterior condition binary
mutate(
exterior_good = case_when(
exterior_condition >= 1 & exterior_condition <= 5 ~ 1,
exterior_condition >= 6 & exterior_condition <= 9 ~ 0,
TRUE ~ NA_real_
)
)
#create dataframes to put in kable
dim_raw <- data.frame(
Dataset = "Raw Property Data",
Rows = nrow(property_data),
Columns = ncol(property_data)
)
dim_clean <- data.frame(
Dataset = "Cleaned Parcel Data",
Rows = nrow(parcel_data),
Columns = ncol(parcel_data)
)
dim_summary1 <- bind_rows(dim_raw, dim_clean)
kable(dim_summary1, caption = "Table 1. Property Dataset Dimensions Before and After Cleaning and Selecting Varaiables")
#load data about poverty(counts and total), bachelors(counts and total), and income
census_data <- get_acs(
geography = "tract",
state = "PA",
county = "Philadelphia",
variables = c(
median_income = "B19013_001",
num_with_bach = "B15003_022",
bachelors_total ="B15003_001",
num_in_poverty = "B17001_002",
poverty_total ="B17001_001"
),
year = 2022,
output = "wide"
)
#create percentage columns for bachelors and poverty
philly_census <- census_data%>%
mutate(
percentage_bach = num_with_bachE / bachelors_totalE,
percentage_pov =  num_in_povertyE / poverty_totalE
)
#remove data errors or incomplete fields
philly_census <- philly_census%>%
drop_na(median_incomeE)%>%
filter(median_incomeE>0)
#spatial census data
philadelphia_tracts <- tracts(
state = "PA",
county = "Philadelphia",
cb = TRUE,
year = 2022
)
#join census data and tract geometry to PARCEL data
parcel_data <- parcel_data %>%
st_transform(st_crs(philadelphia_tracts))%>%
st_join(philadelphia_tracts, join = st_within)%>%
left_join(philly_census, by = "GEOID")
#create dataframes to put in kable
dim_census <- data.frame(
Dataset = "Census Data",
Rows = nrow(census_data),
Columns = ncol(census_data)
)
dim_cen_clean <- data.frame(
Dataset = "Cleaned Census Data",
Rows = nrow(philly_census),
Columns = ncol(philly_census)
)
dim_summary2 <- bind_rows(dim_census, dim_cen_clean)
kable(dim_summary2, caption = "Table 2. Census Dataset Dimensions Before and After Cleaning and Selecting Varaiables")
#load university data
university_data <- st_read("./data/Universities_Colleges.geojson")
#load 2024 crime incident data
org_crime_data <-st_read("./data/incidents_part1_part2.shp")
#removed crime incidents with no geometry
crime_data <- org_crime_data %>%
filter(!st_is_empty(geometry))
#load neighborhood data
neighborhoods <- st_read("./data/philadelphia-neighborhoods.shp")
#create dataframes to put in kable
dim_crime <- data.frame(
Dataset = "Crime Data",
Rows = nrow(org_crime_data),
Columns = ncol(org_crime_data)
)
dim_cri_clean <- data.frame(
Dataset = "Cleaned Crime Data",
Rows = nrow(crime_data),
Columns = ncol(crime_data)
)
dim_summary3 <- bind_rows(dim_crime, dim_cri_clean)
kable(dim_summary3, caption = "Table 3. Spatial Datasets Dimensions Before and After Cleaning")
#distribution of sales prices
ggplot(parcel_data, aes(x = sale_price)) +
geom_histogram(binwidth = 50000, fill="lightgray",color="black") +
scale_x_continuous(labels = label_dollar()) +
labs(
title = " Figure 1. Distribution of Home Sale Prices",
x = "Sale Price",
y = "Frequency"
) +
theme_minimal()+
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
plot.title = element_text(hjust = 0.5),
plot.title.position = "plot"
)
#change projection to prep for join
parcel_proj <- st_transform(parcel_data, 3365)
neighborhood_proj <-st_transform(neighborhoods, 3365)
#associate houses with neighborhoods by joining them based on neighborhoods they fall into
parcel_with_neighborhood <-  st_join(parcel_proj, neighborhood_proj, join = st_within)%>%
st_drop_geometry()%>%
group_by(NAME) %>%
summarize(median_price = median(sale_price, na.rm = TRUE)) #calculate median sales price
neighborhoods_and_prices <- left_join(parcel_with_neighborhood, neighborhoods, by="NAME")
neighborhoods_and_prices <- st_as_sf(neighborhoods_and_prices)
#plot chloropleth
ggplot(neighborhoods_and_prices) +
geom_sf(aes(fill = median_price), color = "white", size = 0.1) +
scale_fill_viridis_c(option = "plasma",
name = "Median Sale Price",
na.value = "grey80",
labels = scales::label_dollar()) +
theme_void() +
labs(
title = "Median Sale Price by Philadelphia Neighborhood"
)
#set crs for distance calculations
crime_proj <- st_transform(crime_data, 3365)
parcel_proj <- st_transform(parcel_data, 3365)
university_proj <- st_transform(university_data, 3365)
#proximity (within 600 feet) to violent crime
parcel_buffers<- st_buffer(parcel_proj, dist=600)
violent_crimes <- c("Homicide - Criminal","Aggravated Assault No Firearm","Theft from Vehicle","Robbery Firearm","Aggravated Assault Firearm")
violent_proj <- crime_proj %>%
filter(text_gener %in% violent_crimes)
violent_crime_counts <- st_intersects(parcel_buffers, violent_proj)
violent_crime_counts <- lengths(violent_crime_counts)
parcel_data$violent_crime_600ft <- violent_crime_counts
#knn to university
university_proj <- st_transform(university_data, 3365) #projection changed in order to calculate distance
dist_matrix <- st_distance(parcel_proj, university_proj)
get_knn_distance <- function(dist_matrix, k) {
apply(dist_matrix, 1, function(distances) {
mean(as.numeric(sort(distances)[1:k]))
})
}
parcel_data$college_nn1 <- get_knn_distance(dist_matrix, k = 1)
parcel_data$college_nn3 <- get_knn_distance(dist_matrix, k = 3)
parcel_data$college_nn5 <- get_knn_distance(dist_matrix, k = 5)
#determine which nearest neighbor is correlated the most with sales price
parcel_data %>%
st_drop_geometry() %>%
select(sale_price, college_nn1, college_nn3, college_nn5) %>%
cor(use = "complete.obs") %>%
as.data.frame() %>%
select(sale_price)
# wealthy neighborhood interaction effects
parcel_proj <- st_transform(parcel_data, 3365)
neighborhood_proj <-st_transform(neighborhoods, 3365)
wealthy_neighborhoods <- parcel_with_neighborhood%>%
filter(median_price >= 275500)%>%
pull(NAME)
parcel_data <- parcel_proj %>%
st_join(neighborhood_proj, join = st_within) %>%
mutate(
wealthy_neighborhood = ifelse(NAME %in% wealthy_neighborhoods, "Wealthy", "Not Wealthy"),
wealthy_neighborhood = as.factor(wealthy_neighborhood)
)
#create log sale price and log livable area for modeling
parcel_data <- parcel_data%>%
mutate(log_sale_price = log(sale_price))
parcel_data <- parcel_data%>%
mutate(log_livable_area = log(total_livable_area))
#structural features only
model1 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good, data = parcel_data)
summary(model1)
#structural + census
model2 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov, data = parcel_data)
summary(model2)
#structural + census + spatial
model3 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)
summary(model3)
#structural + census + spatial + interactions
model4 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)
summary(model4)
parcel_data <- na.omit(parcel_data)
ctrl <- trainControl(
method = "cv",
number = 10  # 10-fold CV
)
model_cv1 <-  train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area +
garage_spaces +
Age + I(Age^2) +
exterior_good,
data = parcel_data,
method = "lm",
trControl = ctrl)
model_cv1
model_cv2 <- train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area  +
garage_spaces +
Age + I(Age^2) +
exterior_good +
median_incomeE +
percentage_bach +
percentage_pov,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv2
model_cv3 <- train(log_sale_price ~
number_of_bathrooms +
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv3
model_cv4 <- train(log_sale_price ~
number_of_bathrooms+
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area * wealthy_neighborhood +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv4
parcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))
library(ggplot2)
ggplot(parcel_data) +
geom_sf(aes(color = residuals_model4), size = 0.4) +
scale_color_gradient2(
low = "blue", mid = "white", high = "red",
midpoint = 0,
name = "Residuals"
) +
labs(
title = "Model 4 Residuals (Parcel Level)",
subtitle = "Red = Overestimated, Blue = Underestimated"
) +
theme_void()
parcel_data$residuals_model4 <- residuals(model4)[as.numeric(rownames(model.frame(model4)))]
parcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))
ctrl <- trainControl(
method = "cv",
number = 10  # 10-fold CV
)
model_cv1 <-  train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area +
garage_spaces +
Age + I(Age^2) +
exterior_good,
data = parcel_data,
method = "lm",
trControl = ctrl)
model_cv1
model_cv2 <- train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area  +
garage_spaces +
Age + I(Age^2) +
exterior_good +
median_incomeE +
percentage_bach +
percentage_pov,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv2
model_cv3 <- train(log_sale_price ~
number_of_bathrooms +
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv3
model_cv4 <- train(log_sale_price ~
number_of_bathrooms+
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area * wealthy_neighborhood +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv4
parcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))
#create log sale price and log livable area for modeling
parcel_data <- parcel_data%>%
mutate(log_sale_price = log(sale_price))
parcel_data <- parcel_data%>%
mutate(log_livable_area = log(total_livable_area))
#structural features only
model1 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good, data = parcel_data)
summary(model1)
#structural + census
model2 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov, data = parcel_data)
summary(model2)
#structural + census + spatial
model3 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)
summary(model3)
#structural + census + spatial + interactions
model4 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)
summary(model4)
parcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))
ctrl <- trainControl(
method = "cv",
number = 10  # 10-fold CV
)
model_cv1 <-  train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area +
garage_spaces +
Age + I(Age^2) +
exterior_good,
data = parcel_data,
method = "lm",
trControl = ctrl)
model_cv1
model_cv2 <- train(log_sale_price ~
number_of_bathrooms +
number_of_bedrooms +
log_livable_area  +
garage_spaces +
Age + I(Age^2) +
exterior_good +
median_incomeE +
percentage_bach +
percentage_pov,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv2
model_cv3 <- train(log_sale_price ~
number_of_bathrooms +
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv3
model_cv4 <- train(log_sale_price ~
number_of_bathrooms+
garage_spaces +
Age + I(Age^2) +
exterior_good +
log_livable_area * wealthy_neighborhood +
median_incomeE +
percentage_bach +
percentage_pov +
college_nn1 +
violent_crime_600ft,
data = parcel_data,
method = "lm",
trControl = ctrl
)
model_cv4
parcel_data$residuals_model4 <- residuals(model4)[as.numeric(rownames(model.frame(model4)))]
library(ggplot2)
ggplot(parcel_data) +
geom_sf(aes(color = residuals_model4), size = 0.4) +
scale_color_gradient2(
low = "blue", mid = "white", high = "red",
midpoint = 0,
name = "Residuals"
) +
labs(
title = "Model 4 Residuals (Parcel Level)",
subtitle = "Red = Overestimated, Blue = Underestimated"
) +
theme_void()
qqnorm(residuals(model4))
qqline(residuals(model4))
plot(cooks.distance(model4),
main = "Cook's Distance for Model 4",
ylab = "Cook's Distance",
xlab = "Observation Index")
model_data_used <- model.frame(model4)
model_data_used$Predicted <- model4$fitted.values
ggplot(model_data_used, aes(x = log_sale_price, y = Predicted)) +
geom_point(alpha = 0.4, color = "steelblue") +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(
title = "Predicted vs Actual (Model 4)",
x = "Actual log(sale_price)",
y = "Predicted log(sale_price)"
) +
theme_minimal()
