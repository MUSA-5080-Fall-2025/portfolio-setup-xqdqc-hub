{
  "hash": "00d89a0f12ccae0f20a52bf04a5f3c42",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Philadelphia Housing Model - Technical Appendix\"\nauthor: \"Your Name\"\nformat: \n  html:\n    code-fold: show\n    toc: true\n    toc-location: left\n    theme: cosmo\nexecute:\n  warning: false\n  message: false\n---\n\n# Phase 1: Data Preparation (Technical Appendix)\n\n\n### Property Sales Data Cleaning\n\nWe filtered our property sales data to only show sales for the past two years to ensure up-to-date insights. We restricted the dataset to `\"SINGLE FAMILY\"` and `\"MULTI FAMILY\"` homes, excluding apartments and non-residential sales to ensure comparability, relevancy, and accuracy in our prediction models. Various apartments contained within the same building were found to be listed with a comprehensive sales price of the entire building which posed the threat of distorting our analysis. Observation values that were regarded as data entry errors or outliers were also removed. Properties with zero bathrooms, bedrooms, or livable area were removed as well as properties with a sales price below \\$10,000 and above \\$1,000,000. \n\n\n### Variable Selection and Variable Data Cleaning\n\nWe retained select structural attributes from our original dataset that we considered theoretically relevant to predicting sale price: number of bedrooms, number of bathrooms, total livable area, year the home was built, exterior condition, availability of garage spaces, and finally, the dependent variable, sale price.\n\n\n**Code for Property Sales Data Cleaning and Variable Selection**\n\n::: {.cell}\n\n```{.r .cell-code}\n#load necessary libraries \nlibrary(sf)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(caret)\nlibrary(knitr)\nlibrary(scales)\n\n#load census key for later use\ncensus_api_key(\"42bf8a20a3df1def380f330cf7edad0dd5842ce6\")\n\n#save data in url \nurl <- \"https://phl.carto.com/api/v2/sql?filename=opa_properties_public&format=geojson&skipfields=cartodb_id&q=SELECT+*+FROM+opa_properties_public\"\n\n#suppress warnings for clarity and read data as spatial object\nsuppressWarnings({\n property_data <- st_read(url)\n})\n\n#clean data\nparcel_data <- property_data%>%\n  select(location, #load columns that could potentially be used as predictors \n         category_code_description, #maybe garage_spaces and central air too?\n         number_of_bedrooms,\n         number_of_bathrooms, \n         total_livable_area,\n         year_built,\n         exterior_condition,\n         garage_spaces,\n         sale_price,\n         sale_date)%>%\n  filter(category_code_description %in% \n  c(\"SINGLE FAMILY\",\"MULTI FAMILY\"))%>% #no apartments, sales price of building\n  drop_na(number_of_bedrooms, #remove anomalies like houses with no rooms\n          number_of_bathrooms,\n          total_livable_area,\n          sale_price,\n          year_built) %>%\n  filter(number_of_bedrooms>0, \n         number_of_bathrooms>0,\n         total_livable_area>0, \n         sale_price>=10000, sale_price <=1000000)%>% #remove very low/high prices\n  mutate(sale_year = str_remove(sale_date, \"-.*\"))%>%   \n  filter(sale_year %in% c(\"2023\",\"2024\"))%>% #limit to only 2023 and 2024\n  mutate(year_built = as.numeric(year_built))%>%\n  mutate(Age = 2025 - year_built)%>% filter(Age <2000)%>% #create a age column\n  filter(exterior_condition != 0) %>% #create exterior condition binary  \n  mutate(\n    exterior_good = case_when(\n      exterior_condition >= 1 & exterior_condition <= 5 ~ 1,\n      exterior_condition >= 6 & exterior_condition <= 9 ~ 0,\n      TRUE ~ NA_real_ \n    )\n  )\n```\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\nTable: Table 1. Property Dataset Dimensions Before and After Cleaning and Selecting Varaiables\n\n|Dataset             |   Rows| Columns|\n|:-------------------|------:|-------:|\n|Raw Property Data   | 583824|      79|\n|Cleaned Parcel Data |  25268|      14|\n\n\n:::\n:::\n\n\n\nWe derived our socioeconomic predictors from tract-level census data provided by the 2022 American Community Survey: median income, number with at least a bachelor's degree, total number of those with at least a bachelor's degree, number of those living in poverty, and total of those living in poverty. Census tracts with missing median income or zero reported as the median income were removed as it often indicated missing or zero values for other key predictors. We also mutated our census dataset to include two more columns, the percentage of people with bachelors and percentage of people in poverty, in order to standardize the observations across varying tract population sizes. Spatial data of the census tracts was also loaded in order to join our census variables to our parcel-level property data.\n\n\n**Code for Census Data Cleaning and Variable Selection**\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data about poverty(counts and total), bachelors(counts and total), and income \ncensus_data <- get_acs(\n  geography = \"tract\",\n  state = \"PA\",\n  county = \"Philadelphia\",\n  variables = c(\n    median_income = \"B19013_001\",\n    num_with_bach = \"B15003_022\",\n    bachelors_total =\"B15003_001\",\n    num_in_poverty = \"B17001_002\",\n    poverty_total =\"B17001_001\"\n  ),\n  year = 2022,\n  output = \"wide\"\n)\n\n#create percentage columns for bachelors and poverty \nphilly_census <- census_data%>%\n  mutate(\n    percentage_bach = num_with_bachE / bachelors_totalE,\n    percentage_pov =  num_in_povertyE / poverty_totalE\n  )\n\n#remove data errors or incomplete fields \nphilly_census <- philly_census%>%\n  drop_na(median_incomeE)%>%\n  filter(median_incomeE>0)\n\n\n#spatial census data \nphiladelphia_tracts <- tracts(\n  state = \"PA\",\n  county = \"Philadelphia\",\n  cb = TRUE,\n  year = 2022\n)\n\n#join census data and tract geometry to PARCEL data\nparcel_data <- parcel_data %>%\n  st_transform(st_crs(philadelphia_tracts))%>%\n  st_join(philadelphia_tracts, join = st_within)%>%\n  left_join(philly_census, by = \"GEOID\")\n```\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\nTable: Table 2. Census Dataset Dimensions Before and After Cleaning and Selecting Varaiables\n\n|Dataset             | Rows| Columns|\n|:-------------------|----:|-------:|\n|Census Data         |  408|      12|\n|Cleaned Census Data |  383|      14|\n\n\n:::\n:::\n\n\n\nTo further contextualize house prices, we loaded spatial datasets including the locations of colleges and universities, 2024 crime incidents, and Philadelphia neighborhood boundaries. These datasets were loaded with the intention of engineering spatial features such as proximity measurements and neighborhood stratification in order to account for spatial patterns and potential interactive spatial effects within our predictive model. Only the 2024 crime incidents needed to be cleaned due to the missing geometries that would prevent spatial analysis.\n\n**Code for Spatial Data Cleaning and Variable Selection**\n\n::: {.cell}\n\n```{.r .cell-code}\n#load university data\nuniversity_data <- st_read(\"./data/Universities_Colleges.geojson\")\n\n#load 2024 crime incident data\norg_crime_data <-st_read(\"./data/incidents_part1_part2.shp\")\n\n#removed crime incidents with no geometry \ncrime_data <- org_crime_data %>%\n  filter(!st_is_empty(geometry))\n\n#load neighborhood data \nneighborhoods <- st_read(\"./data/philadelphia-neighborhoods.shp\")\n```\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\nTable: Table 3. Spatial Datasets Dimensions Before and After Cleaning\n\n|Dataset            |   Rows| Columns|\n|:------------------|------:|-------:|\n|Crime Data         | 160388|      14|\n|Cleaned Crime Data | 153644|      14|\n\n\n:::\n:::\n\n\n\n# Phase 2: Exploratory Data Analysis\n\n### Distribution of Sales Prices\n\nWe created a histogram to visualize the distribution of home sale prices in Philadelphia. The resulting graph revealed a positively skewed distribution, indicating that most properties were sold at lower price points, primarily between \\$150,000 and \\$350,000, while a small number of high-value homes sold for up to \\$1,000,000. As it pertains to our predictive model, this skewness suggests that a log-transformation of sale prices may be necessary to normalize the distribution of values and potentially improve model performance. It also indicates the need for diagnostic checks to determine the impact of outliers in order to ensure that the few high-priced homes do not distort our model estimates.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/histogram of prices-1.png){width=672}\n:::\n:::\n\n\n### Geographic Distribution of Sales Price\n\nWe also explored the geographic distribution of sales prices across the neighborhoods in Philadelphia. We calculated the median sales price by each Philadelphia neighborhood. The map showed distinct spatial patterns with higher prices above \\$400,000, represented by lighter colors, being concentrated in neighborhoods such as Center City, University City, and parts of Northwest Philadelphia. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/chloropleth geographic distribution-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n# Phase 3: Feature Engineering (Technical Appendix)\n\nSeveral geographic features were created. \nFirst, a crime buffer analysis was conducted by generating 600-foot buffers around each parcel. A k-nearest neighbor (kNN) distance measure was calculated between parcels and nearby universities.\nAnd a wealthy neighborhood classification was introduced by spatially joining parcels with neighborhood boundaries and identifying areas with a median sale price above $275,500 as “Wealthy.” This categorical factor was then used to construct an interaction term with living area.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#set crs for distance calculations\ncrime_proj <- st_transform(crime_data, 3365)\nparcel_proj <- st_transform(parcel_data, 3365)\nuniversity_proj <- st_transform(university_data, 3365)\n\n#proximity (within 600 feet) to violent crime\n\nparcel_buffers<- st_buffer(parcel_proj, dist=600)\n\nviolent_crimes <- c(\"Homicide - Criminal\",\"Aggravated Assault No Firearm\",\"Theft from Vehicle\",\"Robbery Firearm\",\"Aggravated Assault Firearm\")\n\nviolent_proj <- crime_proj %>%\n  filter(text_gener %in% violent_crimes)\n    \nviolent_crime_counts <- st_intersects(parcel_buffers, violent_proj)\nviolent_crime_counts <- lengths(violent_crime_counts)\nparcel_data$violent_crime_600ft <- violent_crime_counts\n```\n:::\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#knn to university \n\nuniversity_proj <- st_transform(university_data, 3365) #projection changed in order to calculate distance \n\n\ndist_matrix <- st_distance(parcel_proj, university_proj)\n\n\nget_knn_distance <- function(dist_matrix, k) {\n  apply(dist_matrix, 1, function(distances) {\n    mean(as.numeric(sort(distances)[1:k]))\n  })\n}\n\nparcel_data$college_nn1 <- get_knn_distance(dist_matrix, k = 1)\nparcel_data$college_nn3 <- get_knn_distance(dist_matrix, k = 3)\nparcel_data$college_nn5 <- get_knn_distance(dist_matrix, k = 5)\n\n#determine which nearest neighbor is correlated the most with sales price \n\nparcel_data %>% \n  st_drop_geometry() %>%\n  select(sale_price, college_nn1, college_nn3, college_nn5) %>%\n  cor(use = \"complete.obs\") %>%\n  as.data.frame() %>%\n  select(sale_price)\n```\n:::\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# wealthy neighborhood interaction effects\nparcel_proj <- st_transform(parcel_data, 3365)\nneighborhood_proj <-st_transform(neighborhoods, 3365)\n\n\nwealthy_neighborhoods <- parcel_with_neighborhood%>%\n  filter(median_price >= 275500)%>%\n  pull(NAME)\n\n\nparcel_data <- parcel_proj %>%\n  st_join(neighborhood_proj, join = st_within) %>%\n  mutate(\n    wealthy_neighborhood = ifelse(NAME %in% wealthy_neighborhoods, \"Wealthy\", \"Not Wealthy\"),\n    wealthy_neighborhood = as.factor(wealthy_neighborhood)\n  )\n```\n:::\n\n\n\n\n::: {.cell}\n\n:::\n\n\n# Phase 4: Model Building\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))\n\n#create log sale price and log livable area for modeling\nparcel_data <- parcel_data%>%\n  mutate(log_sale_price = log(sale_price))\n\nparcel_data <- parcel_data%>%\n  mutate(log_livable_area = log(total_livable_area))\n\n#structural features only \nmodel1 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good, data = parcel_data)\n\nsummary(model1)\n\n#structural + census \nmodel2 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov, data = parcel_data)\n\nsummary(model2)\n\n#structural + census + spatial \nmodel3 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model3)\n\n#structural + census + spatial + interactions \nmodel4 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model4)\n```\n:::\n\n**Variables Intepretation:**\n\n*Model1. Structural features only*:\nnumber of bathrooms, livable area (logged), garage_spaces, House_age (Quadratic Effect), exterior condition\n\n*Model2. + Census variables*:\n+ median_income, percentage of bachelor, percentage of poverty\n\n*Model3. + Spatial features*:\n+ nearest college, number of nearby crime\n\n*Model4. + Interactions and fixed effects*:\n+ neighborhood wealthy (interact with livable area)\n\n\n# Phase 5: Model Validation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparcel_data <- parcel_data %>% filter(!if_any(everything(), is.na))\n\nctrl <- trainControl(\n  method = \"cv\",\n  number = 10  # 10-fold CV\n)\n\nmodel_cv1 <-  train(log_sale_price ~ \n                      number_of_bathrooms +\n                      number_of_bedrooms +\n                      log_livable_area +\n                      garage_spaces + \n                      Age + I(Age^2) + \n                      exterior_good,\n                     data = parcel_data,\n                       method = \"lm\",\n                       trControl = ctrl)\n\nmodel_cv1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear Regression \n\n24442 samples\n    7 predictor\n\nNo pre-processing\nResampling: Cross-Validated (10 fold) \nSummary of sample sizes: 21998, 21997, 21998, 21998, 21997, 21997, ... \nResampling results:\n\n  RMSE       Rsquared   MAE      \n  0.6077956  0.3508108  0.4540641\n\nTuning parameter 'intercept' was held constant at a value of TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nmodel_cv2 <- train(log_sale_price ~ \n                     number_of_bathrooms +\n                     number_of_bedrooms + \n                     log_livable_area  +\n                     garage_spaces +\n                     Age + I(Age^2) + \n                     exterior_good + \n                     median_incomeE + \n                     percentage_bach + \n                     percentage_pov,\n                     data = parcel_data,\n                      method = \"lm\",\n                      trControl = ctrl\n)\n\nmodel_cv2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear Regression \n\n24442 samples\n   10 predictor\n\nNo pre-processing\nResampling: Cross-Validated (10 fold) \nSummary of sample sizes: 21998, 21997, 21999, 21998, 21998, 21997, ... \nResampling results:\n\n  RMSE       Rsquared   MAE      \n  0.4952052  0.5687667  0.3540447\n\nTuning parameter 'intercept' was held constant at a value of TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nmodel_cv3 <- train(log_sale_price ~ \n                     number_of_bathrooms +\n                     garage_spaces +\n                     Age + I(Age^2) + \n                     exterior_good + \n                     log_livable_area +\n                     median_incomeE + \n                     percentage_bach +\n                     percentage_pov + \n                     college_nn1 + \n                     violent_crime_600ft,\n                     data = parcel_data,\n                    method = \"lm\",\n                    trControl = ctrl\n)\n\nmodel_cv3\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear Regression \n\n24442 samples\n   11 predictor\n\nNo pre-processing\nResampling: Cross-Validated (10 fold) \nSummary of sample sizes: 21998, 21997, 21997, 21999, 21999, 21996, ... \nResampling results:\n\n  RMSE      Rsquared   MAE      \n  0.489418  0.5790221  0.3483274\n\nTuning parameter 'intercept' was held constant at a value of TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nmodel_cv4 <- train(log_sale_price ~ \n                     number_of_bathrooms+\n                     garage_spaces + \n                     Age + I(Age^2) +\n                     exterior_good + \n                     log_livable_area * wealthy_neighborhood + \n                     median_incomeE +\n                     percentage_bach + \n                     percentage_pov +\n                     college_nn1 + \n                     violent_crime_600ft,\n                     data = parcel_data,\n                      method = \"lm\",\n                    trControl = ctrl\n)\n\nmodel_cv4\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear Regression \n\n24442 samples\n   12 predictor\n\nNo pre-processing\nResampling: Cross-Validated (10 fold) \nSummary of sample sizes: 21998, 21998, 21997, 21997, 21997, 21998, ... \nResampling results:\n\n  RMSE       Rsquared   MAE      \n  0.4824394  0.5907006  0.3414526\n\nTuning parameter 'intercept' was held constant at a value of TRUE\n```\n\n\n:::\n:::\n\n\n**comparison table**\n\n```markdown\n## Model Performance Improves with Each Layer\n\n| Model | CV RMSE (log) | R² |\n|-------|---------------|-----|\n| Structural Only | 0.61 | 0.35 |\n| + Census | 0.50 | 0.57 |\n| + Spatial | 0.49 | 0.58 |\n| + Interactions/FE | 0.48 | 0.59 |\n\n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_data_used <- model.frame(model4)\n\nmodel_data_used$Predicted <- model4$fitted.values\n\nggplot(model_data_used, aes(x = log_sale_price, y = Predicted)) +\n  geom_point(alpha = 0.4, color = \"steelblue\") +\n  geom_abline(slope = 1, intercept = 0, color = \"red\", linetype = \"dashed\") +\n  labs(\n    title = \"Predicted vs Actual (Model 4)\",\n    x = \"Actual log(sale_price)\",\n    y = \"Predicted log(sale_price)\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n\n# Phase 6: Model Diagnostics (Technical Appendix Only)\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/residual plot-1.png){width=672}\n:::\n:::\n\n**Intepretation**:The residuals are spatially clustered: blue areas indicate underestimation (actual prices higher than predicted), while red areas indicate overestimation.This pattern suggests spatial dependence remains in the model, meaning location-specific effects are not fully captured.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/q-q plot-1.png){width=672}\n:::\n:::\n\n**Interpretation**:Most points follow the 45° line, but deviations in the tails show that extreme residuals depart from normality. This indicates the model fits the majority of data well but may underfit high- and low-end price extremes.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](QianmuZheng_Appendix_files/figure-html/cooks distance-1.png){width=672}\n:::\n:::\n\n**Interpretation**:Most observations have Cook’s distance near zero, meaning no influential outliers dominate the model.\n\n\n# Phase 7: Conclusions & Recommendations\n\n**Model Performance**:The final model achieves an adjusted R² of 0.591, explaining nearly 59% of the variation in housing prices across Philadelphia. This represents a major improvement over the baseline Model 1 (R² = 0.35), demonstrating the importance of adding neighborhood and spatial characteristics to structural property features.\n\n**Most Significant Variables**:Among all predictors, living area is the strongest driver of price, followed by the number of bathrooms and garage spaces, which add substantial functional value. Exterior condition, median income, and educational attainment also contribute positively, reflecting the combined effects of property quality and neighborhood socioeconomic context. In contrast, poverty rate and crime density show negative associations, while the interaction between living area and wealthy neighborhoods suggests that larger homes yield diminishing marginal returns in already high-value areas.\n\n**Equity Concern**:The model’s predictive accuracy varies by location. It performs best in mid-range housing markets, while areas such as Nicetown, Fairhill, and Upper Kensington show higher residual errors. These disparities indicate that valuation patterns are still influenced by historical and spatial inequalities, raising potential equity concerns if such models were used in policy or taxation contexts.\n\n\n\n\n\n\n\n\n\n\n",
    "supporting": [
      "QianmuZheng_Appendix_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}